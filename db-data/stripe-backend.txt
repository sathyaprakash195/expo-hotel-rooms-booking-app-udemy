import { serve } from "https://deno.land/std@0.168.0/http/server.ts";

serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response("ok", { headers: cors() });
  }

  const { amount } = await req.json();
  const key = Deno.env.get("STRIPE_SECRET_KEY")!;

  // 1. Customer (with full address to avoid India export warnings)
  const customer = await (await fetch("https://api.stripe.com/v1/customers", {
    method: "POST",
    headers: stripe(key),
    body: new URLSearchParams({
      name: "Test User",
      email: "test@example.com",
      "address[line1]": "123 Test St",
      "address[country]": "US",
      "address[postal_code]": "10001",
    }),
  })).json();

  // 2. Ephemeral Key
  const ephemeralKey = await (await fetch(
    "https://api.stripe.com/v1/ephemeral_keys",
    {
      method: "POST",
      headers: {
        Authorization: `Bearer ${key}`,
        "Stripe-Version": "2024-06-20",
        "Content-Type": "application/x-www-form-urlencoded",
      },
      body: new URLSearchParams({ customer: customer.id }),
    }
  )).json();

  // 3. Payment Intent
  const pi = await (await fetch("https://api.stripe.com/v1/payment_intents", {
    method: "POST",
    headers: stripe(key),
    body: new URLSearchParams({
      amount: String(Math.round(amount * 100)),
      currency: "usd",
      customer: customer.id,
      "automatic_payment_methods[enabled]": "true",
      description:"ExpoHotelRoomsBookingPayment"
    }),
  })).json();

  // 4. Return to the client
  return new Response(
    JSON.stringify({
      clientSecret: pi.client_secret,
      customer: customer.id,
      ephemeralKey: ephemeralKey.secret,
      paymentIntentId: pi.id,
    }),
    { headers: json() }
  );
});

const stripe = (key) => ({
  Authorization: `Bearer ${key}`,
  "Content-Type": "application/x-www-form-urlencoded",
});

const cors = () => ({
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Methods": "POST, OPTIONS",
  "Access-Control-Allow-Headers": "Content-Type, Authorization",
});

const json = () => ({
  ...cors(),
  "Content-Type": "application/json",
});
